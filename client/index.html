<html>                                                                
  <head>
    <meta charset="utf-8">
    <meta name="viewport">
    <title>In The Blood</title>
    <link rel="stylesheet" type="text/css" href="/client/css/mainPageStyle.css"></link>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" src="/client/js/controller.js"></script>
    <script type="text/javascript" src="/client/js/framework.js"></script>
    <script type="text/javascript" src="/client/js/gameLoop.js"></script>
    <script type="text/javascript" src="/client/js/model.js"></script>
    <script type="text/javascript" src="/client/js/playArea.js"></script>
    <script type="text/javascript" src="/client/js/view.js"></script>
    <script>
      var socket = io();                                                                //TODO adjustable resolution based on client and window size    
      var numCanvases = 16;                                                             //change current static size of 1024x768 to smallest base resolution.
      var canvasBag = [];                                            
      var contextBag = [];                                                              //TODO address sluggishness and framerate
      var layerObjects = [];                                                        
      var player = null;
      var player2 = null;
      var playerObjects = [];                                        
      var patientHealth = 1000;                                                         //display related stuff
      var intervalTime = 20;
      var serverAccept = false;                                                         //server connection flags and handling
      var server2init = false;                                                          //TODO rename these to something better 
      var serverAccept2 = false;
      var myInterval
      var playerLayerReceived = false;                                                  //checks to see if information has arrived from the server in a timely manner
      var objectLayerReceived = false;
      var viewLayerReceived = false;
      var keyDownCheck = false;
      var mouseDownCheck = false;
      var gamePaused = false;
      var otherPlayerDropped = false;                                                            
      var pressedKeys = {"a":false,"d":false,"s":false, "w":false, "m":false};          //input related                                    

  socket.on("gameStarted", function(){                                                                  //Start game loop on client when signal received from server that the game is
    serverAccept = true;                                                                                //running on the server
    initGame();
  });

  socket.on("twoPlayerSessionStarted", function(){                                                      //acknowledges that a 2-player session has started on the server and puts
    server2init = true;
    document.getElementById("tempStart").removeEventListener('click', requestGameStart, false);
    document.getElementById("tempStart2").removeEventListener('click', requestTwoPlayerGameStart, false);                                                                                 //client into a wait state until 2nd player is available
    document.getElementById("parent").innerHTML = "game session started. waiting for 2nd player";
  });

  socket.on("twoPlayerGameStarted", function(){                                                         //acknowledges that a 2-player game is running in the previous started 2-player
    serverAccept2 = true;
    console.log("2 player game start received");                                                                               //session.  Beings game loop on client.
    initGame();
  });

  socket.on("serverFull", function(){                                                                   //Server capacity is preliminarily set at 10 sockets.  This signal lets the client know
    document.getElementById("parent").innerHTML = "server full. please wait for game to start";         //that the server is at capacity and puts the client in a wait state.  Wait state will
    requestGameStart();                                                                                 //continually ping the server to check for openings until there is one.
  });

  socket.on("serverFull2", function(){
    document.getElementById("parent").innerHTML = "server full. please wait for game to start";         //Similar to serverFull above, but for 2-player sessions     
    requestTwoPlayerGameStart();
  });

  socket.on("secondPlayerPaused", function(){
    gamePaused = true;
    otherPlayerDropped = true;
    view.displayPauseScreen();
  });

  socket.on("sessionAbandoned", function(){
    otherPlayerDropped = true;                                                             //signal to client if the player in a 2-player session that is not hosting has disconnected mid-game                                                                            //puts the client in an end game state, and enables the client to start a new game
    gamePaused = true;
    view.displayPauseScreen();
  });

  socket.on('playerLayer', function(data){                                                            //controls what the client does when a playerLayer package has arrived from the server
    if(data)
    {
      playerObjects = data;                                                                           //overwrites playerObjects array with new data and sets client player variable appropriately
      player = playerObjects[0];
      if(serverAccept2){player2 = playerObjects[1];}
      playerLayerReceived = true;
    }
    else{playerLayerReceived = false;}
  });

  socket.on('objectLayers', function(data){                                                           //controls what the client does when a objectLayers package has arrived from the server
    if(data)
    {
      layerObjects = data;                                                                            //overwrites layerObjects array with new data
      objectLayerReceived = true;
    }
    else{objectLayerReceived = false;}
  });

  socket.on('viewLayer', function(data){                                                              //controls what the client does when a viewLayer package has arrived from the server
    if(data)
    {
      view.playerScore = data.playerScore;                                                            //updates view layer variables with new information from the server
      view.multiplier = data.multiplier;
      patientHealth = data.patientHealth;
      view.ticks = data.tick;
    }
    else{console.log("no view layer data in package");}
  });

  socket.on('gameOver', function(){                                                                   //tells the client what to do when it has received a signal from the server that the current
    clearInterval(myInterval);                                                                        //game session on the server has ended
    console.log("game over socket:" + socket.id);
    gamePaused = false;
    serverAccept = false;
    serverAccept2 = false;
    server2init = false;
    returnToMain();
  });
      function init()                                                                   //game intro screen
      {
        var introTxt = "";                                           
        introTxt += "<div style='text-align: center; width: 100%'>";
        introTxt += "<br><br><u>STORY</u><br><br>";
        introTxt += "Your patient is infected with a deadly blood disease!<br>";
        introTxt += "The only way to stop the spread of infection is inserting<br>";
        introTxt += "a remotely controlled micro-device that you control in<br>";
        introTxt += " to clean the infected cells from the blood directly<br><br>";
        introTxt += "<u>RULES</u><br><br>";
        introTxt += "1) infections bubble up toward the camera. Black blood cells<br>";
        introTxt += "are about to become infected.  Purple blood cells are infected!<br>";
        introTxt += "Shoot purple cells with your anti-body weapons. Watch out for<br>";
        introTxt += "black cells that may turn into purple cells.<br><br>";
        introTxt += "2) If infected cells float past the bottom of your view, they<br>";
        introTxt += "spread to the rest of the bloodstream and hurt the health of<br>";
        introTxt += "your patient.  The bigger the infection, the bigger the hurt.<br>";
        introTxt += "If your patient's health reaches zero, they die!<br><br>";
        introTxt += "3) Your micro-device is coated in anti-bodies.  You can ram<br>";
        introTxt += "infected cells with your micro-device to destroy them.  However,<br>";
        introTxt += "each collision weakens your micro-device's hull integrity.  If it<br>";
        introTxt += "reaches zero, your micro-device is destroyed and your patient dies!<br><br>";
        introTxt += "<u>CONTROLS</u><br><br>";
        introTxt += "W - Move Forward<br>";
        introTxt += "S - Move Back<br>";
        introTxt += "A - Rotate Left<br>";
        introTxt += "D - Rotate Right<br>";
        introTxt += "Left Click - fire<br>";
        introTxt += "keep your mouse in the play area!<br><br>";
        introTxt += "</div><br>";
        introTxt += "<div><div id='tempStart' style='text-align: center; width: 15%; background-color: red; margin: auto;'>click here for 1 player</div>";
        introTxt += "<div id='tempStart2' style='text-align: center; width: 15%; background-color: orange; margin: auto;'>click here for 2 player</div></div>";
        document.getElementById("parent").innerHTML = introTxt;                                             //display intro text in div found in index  
        document.getElementById("tempStart").addEventListener('click', requestGameStart, false);
        document.getElementById("tempStart2").addEventListener('click', requestTwoPlayerGameStart, false);
        console.log("init page loaded");
        //initialize game session when start is clicked
      }
      
      function initGame()                                                                                   //creates conditions necessary for building the game
      { 
        console.log("initGame function accessed");
        if(!server2init)
        {
          document.getElementById("tempStart").removeEventListener('click', requestGameStart, false);
          document.getElementById("tempStart2").removeEventListener('click', requestTwoPlayerGameStart, false);                                                          
        }
        playArea.makeCanvasTags(numCanvases);                                                               //creates canvas and canvas contexts and places the into array where they can be accessed  
        playArea.makeCanvases(numCanvases);                                                                 
        playArea.makeContexts(numCanvases);                                                                 
        playArea.linkContexts(numCanvases);                                
        playArea.makePlayerLayer();                                                                         //sets up special display layers for objects that arent "enemies"
        playArea.makePlayer2Layer();
        playArea.makeWeaponsLayer();
        view.makeUILayer();                                                                                 //change listeners for mouse input from menu to gameplay
        document.getElementById("parent").style.cursor = "none";                                            //no visible cursor
        document.addEventListener('mousedown', function(){pressedKeys["m"] = true; mouseDownCheck = true;}, false);        
        document.addEventListener('mouseup', function(){pressedKeys["m"] = false;}, false);                 //continuous handling off input outside of the game loop
        document.addEventListener('keydown', keyDownHandler, false);                                 
        document.addEventListener('keyup', keyUpHandler, false);
        myInterval = setInterval(gameLoop, intervalTime)
                                                                                                            //TODO organize socket related functions with socket calls
      }
                                                          
      function requestGameStart()                                                                           //Let server know that client is ready to start 1-player game                                                               
      {
        if(!serverAccept)
        {
          socket.emit('startGame');
          console.log("start game request sent");
        }
        else
        {
          console.log("game start error");
          document.getElementById("parent").innerHTML = "an error occurred. please reload this page.";
        }
      }

      function requestTwoPlayerGameStart()                                                                  //Let server know that client is ready to start 2-player game
      {
        if(!serverAccept2)
        {
          socket.emit('startTwoPlayerGame');
          console.log("start two player game request sent");
        }
        else
        {
          console.log("game start error");
          document.getElementById("parent").innerHTML = "an error occurred. please reload this page.";
        }
      }

      function postGame()                                                                                 //puts the client into a state that enables restart once a game has ended or a 2-player game session
      {                                                                                                   //has been abandoned
        var postText = "";                                                                                //TODO clean this up into a REAL post-game state.
        document.getElementById("parent").style.cursor = "auto";                                          //no visible cursor
        document.removeEventListener('mousedown', function(){pressedKeys["m"] = true;}, false);
        document.removeEventListener('mouseup', function(){pressedKeys["m"] = false;}, false);
        document.removeEventListener('keydown', keyDownHandler, false);                            
        document.removeEventListener('keyup', keyUpHandler, false);
        postText += "<div style='text-align: center; width: 100%'>You Lose!</div>";
        postText += "<div id='tempStart' style='text-align: center; width: 15%; background-color: red; margin: auto;'>click here to restart</div>"
        postText += "<div style='text-align: center; width: 100%'>or close browser tab to quit.</div>";
        document.getElementById("parent").innerHTML = postText;                                           //display intro text in div found in index  
        document.getElementById("tempStart").addEventListener('click', restartGame, false);
      }

      function restartGame()                                                                              //send client from end of game state back to the game intro screen. temp solution.
      {                                                                                                   //TODO handle this automatically without unnecessary extra button press
          document.getElementById("tempStart").removeEventListener('click', restartGame, false);
          if(server2init){socket.emit("sessionReset")}
          else{socket.emit('endGame');}                                                                   //TODO end game and delete game on server side in the post game state
          server2init = false;                                                                            //TODO This should start a new game, not end the old one like it does now.
          init();
      }  
      
      function returnToMain()
      {
        document.getElementById("parent").style.cursor = "auto";                                          //no visible cursor
        document.removeEventListener('mousedown', function(){pressedKeys["m"] = true;}, false);
        document.removeEventListener('mouseup', function(){pressedKeys["m"] = false;}, false);
        document.removeEventListener('keydown', keyDownHandler, false);                            
        document.removeEventListener('keyup', keyUpHandler, false);
        serverAccept = false;
        server2init = false;
        document.getElementById("parent").innerHTML = "";
        canvasBag.length = 0;                                            
        contextBag.length = 0;                                                              //TODO address sluggishness and framerate
        layerObjects.length = 0;                                                        
        player = null;
        player2 = null;
        playerObjects.length = 0;                                                                             //TODO This should start a new game, not end the old one like it does now.
        init();
      }
    </script>
  </head>
  <body>
    <div id="parent">
    </div>
    <div id="signDiv">
      Username: <input id="signDiv-username" type="text"></input><br>
      Password: <input id="signDiv-password" type="password"></input>
      <button id="signDiv-signIn">Sign In</button>
      <button id="signDiv-signUp">Sign Up</button>
    </div>
    <!--
    <div id="chat" style="width:1024px; height:50px; overflow-y:scroll; text-align:center;">
      <form id="chat-form">
        <input id="chat-input" type="text" style="width:1024px;"></input>
      </form>
    </div>
    -->
    <div id="errorMessage"></div>
    <div id = "pauseButtons" style="position:relative; margin-top:768px;">

      <button id="continueButton" style="display:none;">Continue</button>
      <button id="quitButton" style="display:none;">Quit Game</button>

    </div>
    <script>
      var contButton = document.getElementById("continueButton");
      var qtButton = document.getElementById("quitButton");       
                                                                                                         //TODO sign up sign in script in own file. make prettier
      var signDiv = document.getElementById("signDiv");                                                  //sign in and sign up screen           
      var signDivUsername = document.getElementById("signDiv-username");
      var signDivSignIn = document.getElementById("signDiv-signIn");
      var signDivSignUp = document.getElementById("signDiv-signUp");
      var signDivPassword = document.getElementById("signDiv-password");

      contButton.onclick = function(){
        view.removePauseScreen();
        gamePaused = false;
        document.addEventListener('mousedown', function(){pressedKeys["m"] = true; mouseDownCheck = true;}, false);        
        document.addEventListener('mouseup', function(){pressedKeys["m"] = false;}, false);
        socket.emit("continueGame");
      }
      qtButton.onclick = function(){
        socket.emit('endGame');
        view.removePauseScreen();
      }

      signDivSignIn.onclick = function(){                                                                //handles sign in data and sends it to the server if applicable 
        if(isValidFormInput(signDivUsername.value) && isValidFormInput(signDivPassword.value))
        {
          document.getElementById("errorMessage").innerHTML = "";
          socket.emit('signIn', {
          username : signDivUsername.value,
          password : signDivPassword.value});
        }
        else
        {
          document.getElementById("errorMessage").innerHTML = "user name and/or password must be at least 4 characters in length";
        }
      };

      function isValidFormInput(data)                                                                    //super simple format check. will update to much more stringent regex checks in later versions.
      {
        return data.length >= 4;
      }

      signDivSignUp.onclick = function(){                                                               //handles sign up data and sends it to the server if applicable
        socket.emit('signUp', {
        username : signDivUsername.value,
        password : signDivPassword.value});
      };

      socket.on('signInResponse', function(data){                                                       //handles response from server concerning the sign in data
        if(data.success)
        {
          signDiv.innerHTML = "";
          init();
        }
        else 
        {
          document.getElementById("errorMessage").innerHTML = "user name and/or password are not valid";
        }
      });

      socket.on('signUpResponse', function(data){                                                       //handles response from server concerning the sign in data
        if(data.success)                                                                                //currently a bug here where sign up success message does not display
        {
          document.getElementById("errorMessage").innerHTML = "please sign in with your newly created user name and password";
        }
        else
        {
          document.getElementById("errorMessage").innerHTML = "user name is not available. try another.";
        }
      });
      /*
      var chatText = document.getElementById('chat');                                                   //unused script for future chat function capability
      var chatInput = document.getElementById('chat-input');
      var chatForm = document.getElementById('chat-form');
      var DEBUG = false;
      
      socket.on('addToChat', function(data){
        chat.innerHTML =+ '<div>' + data + '</div>';
      });
      
      chatForm.onsubmit = function(e){
        e.preventDefault();
        if(chatInput.value[0] === '/')
        {
          socket.emit('evalServer', chatInput.value.slice(1));
        }
        else
        {
          socket.emit('sendMsgToServer', chatInput.value);
        }
        chatInput.value = '';
      }
      if(DEBUG)  //instead of this, check for DEBUG state on the server
      {
        socket.on('evalAnswer', function(data){
          console.log(data);
        });
      }
      */
    </script>
  </body>
</html>
